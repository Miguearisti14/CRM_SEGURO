{% extends 'layout_panel.html' %}
{% load static %}

{% block title %}Consultar Clientes - ZuluAris CRM{% endblock %}

{% block content %}

    <div>
        <h2 class="titulo-seccion">Consultar Polizas</h2>
    </div>
<div class="card">
    <!--  Buscador -->
    <form class="consulta-filtros" method="get" action="">
            <div class="grupo-busqueda">
                <input 
                    type="text" 
                    name="q" 
                    value="{{ query }}" 
                    placeholder="Buscar por nombre o DNI..."
                    class="input-busqueda"
                >

                <select name="producto" class="input-select">
                    <option value="">Producto</option>
                    {% for producto in productos %}
                        <option value="{{ producto.id }}" {% if producto.id|stringformat:"s" == request.GET.producto %}selected{% endif %}>
                            {{ producto.descripcion }}
                        </option>
                    {% endfor %}
                </select>

                <select name="estado" class="input-select">
                    <option value="">Estado</option>
                    {% for estado in estados %}
                        <option value="{{ estado.id }}" {% if estado.id|stringformat:"s" == request.GET.estado %}selected{% endif %}>
                            {{ estado.descripcion }}
                        </option>
                    {% endfor %}
                </select>

                <button type="submit" class="btn-buscar">Buscar</button>
                    <a href="{% url 'gestionar_clientes' %}" class="btn-limpiar">Limpiar filtro</a>

            </div>
        </form>

    <!-- Tabla de resultados -->
    <table class="tabla_clientes">
        <thead>
            <tr>
                <th class="col-header col-nro">N煤mero de P贸liza</th>
                <th class="col-header col-dni">DNI</th>
                <th class="col-header col-nom">Cliente</th>
                <th class="col-header col-cor">Celular</th>
                <th class="col-header col-prod">Producto</th>
                <th class="col-header col-vig">Estado</th>
            </tr>
        </thead>
        <tbody>
            {% if datos_clientes %}
                {% for item in datos_clientes %}
                    {% for poliza in item.polizas %}
                    <tr>
                        <td class="col-nro">{{ poliza.id }}</td>

                        <td class="col-dni">{{ item.cliente.dni }}</td>
                        <td class="col-nom">
                            <a href="{% url 'detalle_cliente' item.cliente.dni %}" class="cliente-link">
                                {{ item.cliente.nombre }}
                            </a>
                        </td>
                        <td class="col-cor">{{ item.cliente.celular|default:"-"|floatformat:0 }}</td>
                        <!-- Producto -->
                        <td class="col-prod">
                            <a href="{% url 'detalle_poliza' poliza.id %}" class="cliente-link">
                                {{ poliza.id_producto.descripcion }}
                            </a>
                        </td>
                        <!-- Vigencia -->
                        <td class="col-vig" style="">
                            {{ poliza.id_estado.descripcion }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td>{{ item.cliente.dni }}</td>
                        <td>
                            <a href="{% url 'detalle_cliente' item.cliente.dni %}" class="cliente-link">
                                {{ item.cliente.nombre }}
                            </a>
                        </td>
                        <td>{{ item.cliente.celular|default:"-" }}</td>
                        <td>-</td>
                        <td>Sin p贸liza</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align:center;">No hay clientes registrados.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Controles de paginaci贸n -->
    <div class="pagination-container">
        <div class="pagination">

            {% if page_obj.has_previous %}
                <a class="page-link prev" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.producto %}&producto={{ request.GET.producto }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">芦 Anterior</a>
            {% endif %}

            {% for p in page_obj.paginator.page_range %}
                {% if p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                    {% if p == page_obj.number %}
                        <span class="page current">{{ p }}</span>
                    {% else %}
                        <a class="page-link" href="?page={{ p }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.producto %}&producto={{ request.GET.producto }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">{{ p }}</a>
                    {% endif %}
                {% elif p == 1 or p == page_obj.paginator.num_pages %}
                    <a class="page-link" href="?page={{ p }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.producto %}&producto={{ request.GET.producto }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">{{ p }}</a>
                {% elif p == 2 and page_obj.number > 4 %}
                    <span class="dots">...</span>
                {% elif p == page_obj.paginator.num_pages|add:-1 and page_obj.number < page_obj.paginator.num_pages|add:-3 %}
                    <span class="dots">...</span>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a class="page-link next" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.producto %}&producto={{ request.GET.producto }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">Siguiente 禄</a>
            {% endif %}

            <span class="page-info">P谩gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </div>
    </div>

    <div class="acciones-polizas">
        <a href="{% url 'crear_poliza' %}" class="btn-guardar">Nueva p贸liza</a>
    </div>
    
</div>

{% endblock %}